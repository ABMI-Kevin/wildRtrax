# Acoustic data analysis

Now that we transformed raw sensor data into biological detections using Wildtrax we can use this to inform the metrics we're wishing to calculate.

## Authorizing and downloading data from WildTrax

To access WildTrax data using R, you need to follow a series of initial steps.

You should set up your credentials by logging in to WildTrax using Auth0 and storing your username and password as environment variables. 

```r 
Sys.setenv(WT_USERNAME = "guest", WT_PASSWORD = "Apple123")
```

Then, you can authenticate your credentials using the `wt_auth()` function. Once authenticated, you can use various functions to call upon the WildTrax API and download data. For example, the `wt_get_download_summary()` function provides basic metadata about projects that are available for download.

```{r, include = T, eval=F, warning=F, message=F}
wt_auth()


```

```r
wt_get_download_summary()
```

```r
wt_download_report()
```

## Wrangling data for analysis

### Species identification and observer error

Avian population monitoring relies on skilled observers who identify species and estimate population size using visual or acoustic cues. Passive field-based surveys, like "point counts," use distance and time-interval sampling to calculate meaningful metrics such as population size or density. ARU technology has replaced human-based surveys, establishing them as the new standard for bird population monitoring. False positives (FP) and false negatives (FN) in avian datasets are rarely reported, and standardized reporting, assessing, and determining actions to resolve avian identification errors are crucial. By creating open datasets, researchers can merge them together allowing for larger coproduced [Westwood et al.] and reproducible analyses [REFERENCE]. The integration of traditional human-collected and acoustic data is key to avian monitoring management implications and conservation goals.

A standardized system of reporting, assessing and determining actions to resolve avian identification error is crucial to ensure that reporting meets a high data quality standard and that it can be used comfortably in aggregation with other data to answer a wider range of scientific questions. The goals were to provide a standard way of assessing the prevalence of false positives, false negatives and true negatives in avian datasets, to provide solutions to correct and integrate identification error into analyses, and to provide recommendations for the evaluation, training and development of skilled observers.

```{r, include = T, eval=F, warning=F, message=F}

# Omit any abiotic data
abiotic_codes <- c('LIBA','MOBA','HEBA','LITR','MOTR','HETR','LINO','MONO','HENO',
                 'LIRA','MORA','HERA','LIWI','MOWI','HEWI','LIAI','MOAI','HEAI',
                 'LITN','MOTN','HETN','LIDT','MODT','HEDT','LITF','MOTF','HETF')

```

```{r, include=T, eval=T, warning=F, message=F, prompt=T, comment=""}
# Import the species table
head(cls)

```

The `wildRtrax::wt_ord` function conducts a series of steps to return the results of a multi-observer project. The first step in this process involves tidying and preparing the data in a species matrix. The function then runs a redundancy analysis (RDA) on the observer with recording, in other words, location (spatial component) and recording date (temporal component), as a constrained effect. This statistical technique is commonly used to determine the relationship between a set of response variables and a set of predictor variables. In the context of this analysis, the RDA is used to determine the relationship between the observer and the species detections. 

The `wt_ord` function also conducts variance partitioning where necessary to determine the contribution of predictor variables in the RDA. This process helps to identify the factors that have the greatest influence on the relationship between the observer and the species detections, such as the geographic region or habitat type determined by the locations used in the analysis. The function also returns results of a *PERMANOVA*, adjusted *R*-squared, and *F*-statistic to provide information on the overall strength and significance of the relationship of the ordination. The *PERMANOVA* is a non-parametric statistical method used to test the null hypothesis that there is no difference in the means of the groups being compared. The adjusted *R*-squared and *F*-statistic provide information on how well the model fits the data, and the significance of the differences observed between the groups.

In addition to the RDA, the `wt_ord` function also runs a generalized linear mixed model (GLMM) on the tag start time against observer, with recording as a random effect. GLMMs are widely used in statistical analysis, and are especially useful for analyzing data that has both fixed and random effects. By using a GLMM in this context, the `wt_ord` function can determine if there are any significant differences between the observers and the mean of the group.

```{r, include = T, eval=F, warning=F, message=F}
# Using the most recent quality control
res <- wt_ord(input = data, min_obs = 11, confidence = 0.67)

```

### False negative rates and BirdNET

When processing a task, it is possible for an observer to miss an individual. This *false negative* (FN) state can be addressed by utilizing [BirdNET](https://birdnet.cornell.edu/?repeat=w3tc), a software tool that detects the species in 3-second intervals and intersects it with the tag, resulting in a maximum probability score ranging from 0 to 1. WildTrax, which utilizes the BirdNET API, can extract the maximum probability score exclusively for the species in question from all 3-second intervals that intersect with the tag, returning it as a result. This probability score indicates the likelihood of BirdNET detecting the species in that specific interval, and if BirdNET fails to detect the species, the probability score will be 0.

![](assets/oven-birdnet.png)

Once all tasks are transcribed, access the [Data Downloads](https://www.wildtrax.ca/home/projects/data-download.html) page and extract the zip file to obtain the summary report and *_recording_birdnet_summary.csv*. These files will be used to intersect the human-created tags with the results obtained from BirdNET.

```{r, include = T, eval=T, warning=F, message=F}
# Load and prepare the BirdNET data
raw_data

```

```{r, include = T, eval=T, warning=F, message=F}
fn <- raw_data %>%
  select(location, recording_date, scientific_name, window_start_time, confidence) %>%
  distinct() %>%
  inner_join(., cls %>% select(species_code, species_common_name, scientific_name), by = c("scientific_name" = "scientific_name")) %>%
  add_column(observer = "BirdNET") %>%
  add_column(project_name = "BirdNET Output") %>%
  select(project_name, location, recording_date, observer, species_code, species_common_name, window_start_time, confidence) %>%
  rename("tag_start_s" = 7,
         "is_verified" = 8) %>%
  select(location, recording_date, observer, species_code, species_common_name, tag_start_s, is_verified) %>%
  distinct() %>%
  add_column(project_name = "Ecosystem Health 2021") %>%
  relocate(project_name) %>%
  relocate(is_verified, .before = tag_start_s) %>%
  filter(species_code == "LCSP",
         !grepl("^2022-",recording_date),
         tag_start_s <= 60) %>%
  select(-tag_start_s) %>%
  group_by(project_name, location, recording_date, observer, species_code, species_common_name) %>%
  summarise(is_verified = max(is_verified)) %>%
  ungroup()

```

```{r, include = T, eval=T, warning=F, message=F}
hh <- read_csv("/users/alexandremacphail/desktop/abmieco21/basic_summary.csv") %>%
  filter(status == "Transcribed") %>%
  mutate(length = as.numeric(str_extract(method, '^[^s]*'))) %>%
  select(project_name, location, recording_date, length, observer, species_code, species_common_name, is_verified) %>%
  distinct() %>%
  mutate(is_verified = case_when(TRUE ~ 100, TRUE ~ 0)) %>%
  filter(species_code == "LCSP") %>%
  select(-length) %>%
  distinct()

bind_rows(fn, hh) %>%
  pivot_wider(names_from = observer, values_from = is_verified) %>%
  rowwise() %>%
  mutate(diff = max(c_across(!project_name:BirdNET), na.rm=T),
         diff = case_when(is.infinite(diff) ~ 0, TRUE ~ diff)) %>%
  ungroup() %>%
  select(project_name, location, recording_date, species_code, species_common_name, BirdNET, diff) %>%
  filter(diff == 0)
  
```

So we have one potential false negative WTSP:

### Abundance estimation

Estimating abundance is crucial for understanding population dynamics and making informed conservation decisions. By accurately quantifying the number of individuals within a survey area, researchers can track population changes over time and evaluate the effectiveness of conservation or management efforts. This is typically done through repeated surveys over time, which allow for the calculation of important population metrics such as occupancy, detectability, and colonization/extinction.

However, sometimes estimating abundance is not always possible, particularly when dealing with large or elusive species. In these cases, the WildTrax platform uses "Too Many to Tag" (TMTT) as a way to indicate that the number of individuals cannot be directly counted or estimated. To address this issue, `wildRtrax` provides the `wt_replace_tmtt` function, which runs a generalized linear mixed model using existing data in the dataset to generate a numeric value for TMTT.

![](assets/tmtt.png)

For instance, if a survey records 100 detections, of which 70 are abundance = 1, 29 are abundance = 2, and 1 is abundance = TMTT, the function would estimate the TMTT value at approximately 1.2. This helps improve the accuracy of abundance estimates and allows for more robust analysis.

```{r, include = T, eval=F, warning=F, message=F}
wt_replace_tmtt()

```

## Basic analysis

Wildtrax provides the basis for a variety of different biological metrics and data, which can be analyzed using basic statistical techniques to gain insights into wildlife populations and their distribution.

### Species presence

Species presence refers to the occurrence or existence of a species within the sampling radius of a given geographic location. In ecology, understanding species presence is crucial for analyzing the distribution and abundance of species and for identifying factors that affect their survival and persistence.

Presence is usually defined as a binary variable (*0*, *1*) where *0* is the absence of the species during an observation, and *1* indicates presence.

```{r, include = T, eval=T, warning=F, message=F}

data_summary <- raw_basic_data %>% 
  filter(!species_code %in% abiotic_codes,
         !grepl('^U',species_code)) %>%
  mutate(present = case_when(species_code == "SOSP" ~ 1, TRUE ~ 0)) %>%
  select(location, latitude, longitude, recording_date, species_code, individual_appearance_order, present) %>%
  distinct() %>%
  mutate(hour = hour(recording_date),
         julian = yday(recording_date)) %>%
  inner_join(., inp, by = c("location" = "location")) %>%
  relocate(-(location:julian), .after = longitude) %>%
  relocate(present:julian, .after = recording_date) %>%
  group_by_at(vars(location:species_code)) %>%
  summarise(abundance = max(individual_appearance_order)) %>%
  ungroup() %>%
  pivot_wider(names_from = species_code, values_from = abundance, values_fill = 0) %>%
  mutate(id = row_number())

dp <- data_summary %>%
  select(location, latitude, longitude, present) %>%
  distinct() %>%
  filter(present == 1) %>%
  st_as_sf(coords = c("longitude","latitude"))

dp <- st_set_crs(dp, 4269)

ggplot() +
  geom_sf(data = st_crop(LPP_c, xmin = 723300, xmax = 729250, ymin = 6076950, ymax = 6083050), aes(fill=LC_name)) +
  geom_sf(dp, mapping = aes(), colour= "red") +
  geom_sf(onebadr_buff, mapping = aes(), fill = NA, colour="black") +
  theme_bw() +
  scale_colour_viridis_d() +
  scale_fill_manual(values = colours)

```

```{r}

#Create training set
train <- data_summary %>% sample_frac(.70)
#Create test set
test  <- anti_join(data_summary, train, by = 'id')

data_summary %>%
  ggplot(., aes(x=Water, y=present)) +
  geom_point(alpha = 0.2) +
  theme_bw() +
  geom_smooth(method = "glm", method.args = list(family = "gaussian")) +
  labs(title = "Regression Model") +
  theme(axis.text.x = element_blank())

# create a logistic regression model
model <- glm(present ~ Water + julian, data = train, family="gaussian")

# summary of the model
summary(model)

# Make predictions
probabilities <- model %>% predict(test, type = "response")

#Predict
predicted.classes <- ifelse(probabilities > 0, 1, 0)

# Model accuracy. If 1 = 100% prediction accuracy
mean(predicted.classes == test$SOSP)
```
The model therefore has a probability of 41.6% of detecting SOSP near water.

### Species accumulation and rarefaction

Species accumulation refers to the process of counting the number of different species present in a sample of a particular size. The idea is to keep adding new samples until the total number of species observed reaches a plateau or levels off. The curve that results from plotting the number of species against the number of samples is called a species accumulation curve, and it provides information about the rate of species discovery and the completeness of sampling.

```{r}

dj <- data %>% 
  select(location, recording_date, species_code, individual_appearance_order, abundance) %>%
  mutate(abundance = case_when(abundance == "TMTT" ~ "4", abundance == "CI 1" ~ "1", abundance == "CI 2" ~ "2", abundance == "CI 3" ~ "3", TRUE ~ abundance),
           abundance = as.numeric(abundance)) %>%
    group_by(location, recording_date, species_code) %>%
    mutate(indvs = max(individual_appearance_order)) %>%
    ungroup() %>%
  group_by(location, recording_date, species_code) %>%
    summarise(abundance = case_when(max(abundance) > max(individual_appearance_order) ~ max(abundance), TRUE ~ max(individual_appearance_order))) %>%
    ungroup()

ddj <- dj %>%
  filter(!species_code %in% abiotic_codes, !species_code == "NONE") %>%
  mutate(abundance = as.numeric(abundance)) %>%
  pivot_wider(names_from = species_code, values_from = abundance, values_fill = 0) %>%
  as.data.frame()

x <- vegan::specaccum(ddj[,3:228], method = "random")
boxplot(x)

```

Rarefaction is a statistical method used to estimate the expected number of species in a community, given a fixed number of individuals or samples. This technique is particularly useful when comparing the diversity of different communities that have been sampled unevenly, i.e., with different sample sizes. The rarefaction curve represents the expected number of species in a community as a function of the number of individuals or samples, and it can help researchers make fair comparisons of diversity between communities.

```{r}

vegan::rarecurve(ddj[,3:228])

```

### Diversity indices

We can also interpret certain ecological diversity indices from other functions in the `vegan` package.

```{r}

diversity(ddj[,3:228], index="shannon") %>%
  as_tibble() %>%
  bind_cols(., ddj %>% select(location)) %>%
  inner_join(., out %>% st_drop_geometry() %>% select(location, BCRNAME), by = c("location" = "location")) %>%
  group_by(BCRNAME) %>%
  add_tally() %>%
  ungroup() %>%
  ggplot(., aes(x=BCRNAME,y=value,group=BCRNAME,fill=BCRNAME)) + 
  geom_boxplot(aes(weight=n)) + 
  theme_bw() +
  scale_fill_viridis_d() +
  theme(axis.text.x = element_blank()) +
  xlab("Bird Conservation Region") +
  ylab("Shannon Diversity") +
  ggtitle("Shannon Diversity Index across Bird Conservation Regions of Alberta")


```

## Advanced analysis

### Occupancy modelling

```{r, include = T, eval=F, warning=F, message=F}
wt_occupancy()

```

### Constructing a classifier

```{r, include = T, eval=F, warning=F, message=F}
wt_download_tag_report()

```
